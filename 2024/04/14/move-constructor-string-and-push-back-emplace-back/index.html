<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" integrity="sha256-jTIdiMuX/e3DGJUGwl3pKSxuc6YOuqtJYkM0bGQESA4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"detcher.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.10.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Take-away|_nothing here, sir_|">
<meta property="og:type" content="article">
<meta property="og:title" content="move constructor, string and push_back&#x2F;emplace_back">
<meta property="og:url" content="https://detcher.github.io/2024/04/14/move-constructor-string-and-push-back-emplace-back/index.html">
<meta property="og:site_name" content="Detcher&#39;s Blog">
<meta property="og:description" content="Take-away|_nothing here, sir_|">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://detcher.github.io/2024/04/14/images/2404142336.png">
<meta property="og:image" content="https://detcher.github.io/2024/04/14/images/2404142337.png">
<meta property="og:image" content="https://detcher.github.io/2024/04/14/images/2404142338.png">
<meta property="article:published_time" content="2024-04-14T12:04:37.000Z">
<meta property="article:modified_time" content="2024-05-03T01:56:50.981Z">
<meta property="article:author" content="Detcher">
<meta property="article:tag" content="cpp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://detcher.github.io/2024/04/14/images/2404142336.png">


<link rel="canonical" href="https://detcher.github.io/2024/04/14/move-constructor-string-and-push-back-emplace-back/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://detcher.github.io/2024/04/14/move-constructor-string-and-push-back-emplace-back/","path":"2024/04/14/move-constructor-string-and-push-back-emplace-back/","title":"move constructor, string and push_back/emplace_back"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>move constructor, string and push_back/emplace_back | Detcher's Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Detcher's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">SoloDoloBoi.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Take-away"><span class="nav-number">1.</span> <span class="nav-text">Take-away</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Disclaim"><span class="nav-number">2.</span> <span class="nav-text">Disclaim</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reference"><span class="nav-number">3.</span> <span class="nav-text">Reference</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Keywords"><span class="nav-number">4.</span> <span class="nav-text">Keywords</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Unwind-a-simplified-version-of-std-string-i-mean%E2%80%A6-vastly-simplified"><span class="nav-number">5.</span> <span class="nav-text">Unwind a simplified version of std::string, i mean… vastly simplified</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Give-it-a-shot"><span class="nav-number">5.1.</span> <span class="nav-text">Give it a shot</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1"><span class="nav-number">5.1.1.</span> <span class="nav-text">#1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2"><span class="nav-number">5.1.2.</span> <span class="nav-text">#2</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mine"><span class="nav-number">5.2.</span> <span class="nav-text">Mine</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Move-semantic-but-in-rust"><span class="nav-number">6.</span> <span class="nav-text">Move semantic, but in rust</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#End-Possibly-not%E2%80%A6"><span class="nav-number">7.</span> <span class="nav-text">End? Possibly not…</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Detcher"
      src="/images/avator3.gif">
  <p class="site-author-name" itemprop="name">Detcher</p>
  <div class="site-description" itemprop="description">Hip-Hop/Programming</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://detcher.github.io/2024/04/14/move-constructor-string-and-push-back-emplace-back/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator3.gif">
      <meta itemprop="name" content="Detcher">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Detcher's Blog">
      <meta itemprop="description" content="Hip-Hop/Programming">
    </span>
    
    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="move constructor, string and push_back/emplace_back | Detcher's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          move constructor, string and push_back/emplace_back
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-04-14 20:04:37" itemprop="dateCreated datePublished" datetime="2024-04-14T20:04:37+08:00">2024-04-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-05-03 09:56:50" itemprop="dateModified" datetime="2024-05-03T09:56:50+08:00">2024-05-03</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="Take-away"><a href="#Take-away" class="headerlink" title="Take-away"></a>Take-away</h2><p>|_nothing here, sir_|</p>
<span id="more"></span>

<h2 id="Disclaim"><a href="#Disclaim" class="headerlink" title="Disclaim"></a>Disclaim</h2><p>Currently a C++ newbie, still on the road…</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://www.thecodedmessage.com/posts/cpp-move/">https://www.thecodedmessage.com/posts/cpp-move/</a></p>
<h2 id="Keywords"><a href="#Keywords" class="headerlink" title="Keywords"></a>Keywords</h2><ul>
<li>move ctor</li>
<li>temporary object</li>
<li>std::string class</li>
<li>push_back()&#x2F;emplace_back() in std::vector</li>
</ul>
<h2 id="Unwind-a-simplified-version-of-std-string-i-mean…-vastly-simplified"><a href="#Unwind-a-simplified-version-of-std-string-i-mean…-vastly-simplified" class="headerlink" title="Unwind a simplified version of std::string, i mean… vastly simplified"></a>Unwind a simplified version of std::string, i mean… vastly simplified</h2><p>Below is the program crafted by <a target="_blank" rel="noopener" href="https://www.thecodedmessage.com/string_example/string.cpp">the code message</a> with some customized changes; in case you don’t wanna click the link, i put a copy here:)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MOVE</span></span><br><span class="line"><span class="comment">// #define OUTPUT_STRINGS</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> alloc_count&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> *<span class="title">logging_alloc</span><span class="params">(<span class="type">size_t</span> n)</span> </span>&#123;</span><br><span class="line">    ++alloc_count;</span><br><span class="line">    std::cerr &lt;&lt; <span class="string">&quot;Allocating &quot;</span> &lt;&lt; n &lt;&lt; <span class="string">&quot; bytes&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">char</span>[n];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">string</span> &#123;</span><br><span class="line">    <span class="type">char</span> *m_str; <span class="comment">// In modern C++, should use std::unique_ptr</span></span><br><span class="line">                 <span class="comment">// But doing manual memory management for explanation&#x27;s sake</span></span><br><span class="line">    <span class="type">size_t</span> m_len;</span><br><span class="line">    <span class="comment">// No capacity for dead simplicity</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// For internal use, for + operator</span></span><br><span class="line">    <span class="built_in">string</span>(<span class="type">char</span> *str, <span class="type">size_t</span> len) :</span><br><span class="line">        <span class="built_in">m_str</span>(str), <span class="built_in">m_len</span>(len) &#123; &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// Accessor</span></span><br><span class="line">    <span class="function"><span class="type">char</span> *<span class="title">c_str</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> m_str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize from C string</span></span><br><span class="line">    <span class="built_in">string</span>(<span class="type">const</span> <span class="type">char</span> *str) &#123;</span><br><span class="line">        m_len = <span class="built_in">strlen</span>(str);</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;CstrLen: &quot;</span> &lt;&lt; m_len &lt;&lt; std::endl;</span><br><span class="line">        m_str = <span class="built_in">logging_alloc</span>(m_len + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(m_str, str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Default constructor</span></span><br><span class="line">    <span class="built_in">string</span>() &#123;</span><br><span class="line">        m_str = <span class="literal">nullptr</span>;</span><br><span class="line">        m_len = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Copy constructor</span></span><br><span class="line">    <span class="built_in">string</span>(<span class="type">const</span> string &amp;other) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;copy ctor&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        m_len = other.m_len;</span><br><span class="line">        m_str = <span class="built_in">logging_alloc</span>(m_len + <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">strcpy</span>(m_str, other.m_str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Assignment: Uses copy (or move) constructor to construct argument</span></span><br><span class="line">    <span class="comment">// Uses destructor to free own allocation. This is a trick to avoid</span></span><br><span class="line">    <span class="comment">// having to implement two assignment operators for move and copy</span></span><br><span class="line">    <span class="comment">// assignment in addition to two constructors for moving and copying.</span></span><br><span class="line">    <span class="comment">// Many types, for various reason, still define the two types of</span></span><br><span class="line">    <span class="comment">// assignment separately.</span></span><br><span class="line">    string &amp;<span class="keyword">operator</span>=(string other) &#123;</span><br><span class="line">        std::<span class="built_in">swap</span>(m_len, other.m_len);</span><br><span class="line">        std::<span class="built_in">swap</span>(m_str, other.m_str);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> MOVE</span></span><br><span class="line">    <span class="comment">// Move constructor</span></span><br><span class="line">    <span class="built_in">string</span>(string &amp;&amp;other) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;move ctor&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        m_len = other.m_len;</span><br><span class="line">        m_str = other.m_str;</span><br><span class="line">        other.m_str = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">friend</span> string <span class="keyword">operator</span>+(<span class="type">const</span> string &amp;a, <span class="type">const</span> string &amp;b) &#123;</span><br><span class="line">        <span class="type">size_t</span> len = a.m_len + b.m_len + <span class="number">1</span>;</span><br><span class="line">        <span class="type">char</span> *str = <span class="built_in">logging_alloc</span>(len);</span><br><span class="line">        <span class="built_in">strcpy</span>(str, a.m_str);</span><br><span class="line">        <span class="built_in">strcat</span>(str, b.m_str);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">string</span>(str, len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    string &amp;<span class="keyword">operator</span>+=(<span class="type">const</span> string &amp;other) &#123;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span> = *<span class="keyword">this</span> + other;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">string</span>() &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;dtor&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">delete</span> [] m_str;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    std::vector&lt;string&gt; v;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; argc; ++i) &#123;</span><br><span class="line">        <span class="comment">// v.push_back(string(argv[i])); // #1: copy in c++03, move in c++11</span></span><br><span class="line">        <span class="comment">// v.emplace_back(argv[i]);      // #2: and emplace_back()?</span></span><br><span class="line">        &#123; <span class="comment">// essence of temporary object? | same as #1</span></span><br><span class="line">            string _temp(argv[i]);</span><br><span class="line">            v.<span class="built_in">push_back</span>(std::<span class="built_in">move</span>(_temp));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> output_strings</span></span><br><span class="line">    <span class="function">string <span class="title">acc</span><span class="params">(<span class="string">&quot;&quot;</span>)</span></span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;str: v) &#123;</span><br><span class="line">        acc += str;</span><br><span class="line">        acc += <span class="built_in">string</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; acc.<span class="built_in">c_str</span>() &lt;&lt; std::endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;total allocations: &quot;</span> &lt;&lt; alloc_count &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Give-it-a-shot"><a href="#Give-it-a-shot" class="headerlink" title="Give it a shot"></a>Give it a shot</h3><p>(<strong>try your own prompt</strong>)</p>
<h4 id="1"><a href="#1" class="headerlink" title="#1"></a>#1</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ ./1 ich bin Detcher                                                                               </span><br><span class="line">---CstrLen: 3</span><br><span class="line">Allocating 4 bytes</span><br><span class="line">move ctor</span><br><span class="line">dtor</span><br><span class="line">---CstrLen: 3</span><br><span class="line">Allocating 4 bytes</span><br><span class="line">move ctor</span><br><span class="line">move ctor</span><br><span class="line">dtor</span><br><span class="line">dtor</span><br><span class="line">---CstrLen: 3</span><br><span class="line">Allocating 4 bytes</span><br><span class="line">move ctor</span><br><span class="line">move ctor</span><br><span class="line">dtor</span><br><span class="line">move ctor</span><br><span class="line">dtor</span><br><span class="line">dtor</span><br><span class="line">---CstrLen: 7</span><br><span class="line">Allocating 8 bytes</span><br><span class="line">move ctor</span><br><span class="line">dtor</span><br><span class="line">Total allocations: 4</span><br><span class="line">dtor</span><br><span class="line">dtor</span><br><span class="line">dtor</span><br><span class="line">dtor</span><br></pre></td></tr></table></figure>

<h4 id="2"><a href="#2" class="headerlink" title="#2"></a>#2</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ ./1 ich bin Detcher                                                                               </span><br><span class="line">---CstrLen: 3</span><br><span class="line">Allocating 4 bytes</span><br><span class="line">---CstrLen: 3</span><br><span class="line">Allocating 4 bytes</span><br><span class="line">move ctor</span><br><span class="line">dtor</span><br><span class="line">---CstrLen: 3</span><br><span class="line">Allocating 4 bytes</span><br><span class="line">move ctor</span><br><span class="line">dtor</span><br><span class="line">move ctor</span><br><span class="line">dtor</span><br><span class="line">---CstrLen: 7</span><br><span class="line">Allocating 8 bytes</span><br><span class="line">Total allocations: 4</span><br><span class="line">dtor</span><br><span class="line">dtor</span><br><span class="line">dtor</span><br><span class="line">dtor</span><br></pre></td></tr></table></figure>

<p>so… any thoughts about these?</p>
<h3 id="Mine"><a href="#Mine" class="headerlink" title="Mine"></a>Mine</h3><p><strong>(Part of…)</strong></p>
<ul>
<li><p><strong>std::move()</strong> doesn’t do anything, it’s just like <code>static_cast&lt;SomeType &amp;&amp;&gt;(Some) -&gt; rvalue</code>, some type-conversion stuffs; And the actual <strong>MOVE</strong> happens in <strong>move ctor</strong>!</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=Bt3zcJZIalk">Back to Basics: Move Semantics - Nicolai Josuttis - CppCon 2021</a></p>
<ul>
<li><code>string e2 = std::move(y)</code> &#x3D;&#x3D; <code>string e2(string &amp;&amp;y)</code> | invoking string’s move ctor where the actual MOVE truly happens</li>
<li>For temporary objects like <code>string(&quot;foo&quot;)</code>, it will end up in its dtor when reaching <strong>the end of one expression</strong>(bg: a temp can invoke its member functions like dtor)</li>
</ul>
<img src="../images/2404142336.png" style="zoom:50%;" />
<img src="../images/2404142337.png" style="zoom:50%;" />
<img src="../images/2404142338.png" style="zoom:50%;" />
</li>
<li><p>Move semantic only make sense to <strong>moveable resources</strong> like heap data etc; “In the case of std::string, we have some non-moveable data” like SSO(“additional bytes for the Small String Optimization, something around 16 bytes” <strong>on the stack</strong>)</p>
<ul>
<li>Rust makes a special case for types that do not need move semantics, where <strong>the value itself contains all the information necessary to represent it</strong>, where no heap allocations or resources are managed by the value, types like i32</li>
</ul>
</li>
</ul>
</li>
<li><p>Notice the <strong>RESIZEing</strong> of a vector everytime when reaching its capacity, especially <strong>moving</strong> old contents(the <strong>ownership</strong> actually, happened in move ctor) to a newly-double-capacity place(n-&gt;2*n) and <strong>dtor of each vector&lt;string&gt;[old_cap] elements</strong></p>
<ul>
<li>Better call <a target="_blank" rel="noopener" href="https://cpp-optimizations.netlify.app/reserve/">RESERVE</a></li>
</ul>
</li>
<li><p>Temporary object stays in the <strong>stack</strong>(automatic storage)</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/a/10966492/17485872">https://stackoverflow.com/a/10966492/17485872</a></li>
<li><strong>Where there is a type-collision, there is a temporary object</strong>; like for <code>vector.push_back(&quot;foo&quot;)</code> is <code>const char[4]-&gt;std::string</code></li>
</ul>
</li>
<li><p>It’s easily to observe the difference between <code>.push_back()</code> and <code>.emplace_back()</code> from outputs, while one using the intermediated <strong>temporary</strong> and the other emplace the object <strong>in place</strong></p>
<ul>
<li>Does it mean emplace-back is way better than push-back? Well, see <a target="_blank" rel="noopener" href="https://andreasfertig.blog/2023/04/push_back-vs-emplace_back-when-to-use-what/">when-to-use-what</a> for more details</li>
<li><a target="_blank" rel="noopener" href="https://abseil.io/tips/112">https://abseil.io/tips/112</a></li>
</ul>
</li>
</ul>
<h2 id="Move-semantic-but-in-rust"><a href="#Move-semantic-but-in-rust" class="headerlink" title="Move semantic, but in rust"></a>Move semantic, but in rust</h2><ul>
<li><strong>Run-time cost</strong>: due to the limitation and unflexibility of RAII, there will be some unnecessary and inevitable boiler-plate code(check) generated at run-time, while rust does all these things at compile-time<ul>
<li>RAII is a <strong>Trade-off</strong>, unflexible for ergonomic; like <code>.unlock()</code> or this case</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// de-sugaring and post-inlining</span></span><br><span class="line">...</span><br><span class="line">foo = <span class="literal">nullptr</span>;      <span class="comment">// in move ctor</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (foo != <span class="literal">nullptr</span>) <span class="comment">// in dtor</span></span><br><span class="line">    <span class="built_in">free</span>(foo);</span><br><span class="line"><span class="comment">// This null check is hidden by the fact that in C++, free and delete and friends are defined to be no-ops on null, but it still exists</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>Not always MOVE</strong>: in cpp, MOVE may not happen all the time as expected, plus it’s not the default or mandatory, and it might degrade to COPY <strong>implicitly</strong>, while in rust, the default option is MOVE and if you seek a deep copy, <strong>explicitly</strong> invoking <code>.clone()</code></p>
<blockquote>
<p>This is already an advantage to Rust. C++ pretends that all types are the same, even though they require different usage patterns in practice. You can pass a std::string by copy just like an int. Even if you have a vector of vectors of strings, you can pass by copy and that’s usually the default way to pass it – moves in many cases require explicit opt-in. For int it’s a reasonable default, but for collections types it isn’t, and in Rust the programming language is designed accordingly.</p>
</blockquote>
<blockquote>
<p>Indeed, for reasons of consistency and generic programming, move is defined on all types that can be moved or copied, even types that don’t implement move differently than copy.</p>
</blockquote>
<blockquote>
<p>What makes this confusing in C++, however, is that types that manage resources might be written without an implementation of move. They might pre-date the move feature, or their implementor might not have understood move well enough to implement them, or there might be a technical reason why moving couldn’t be implemented in a way that elides the resource duplication. For these types, a move falls back on a copy, even if the copy does significant work. This can be surprising to the programmer, and surprises in programming are never good. More direly, there is no warning when this happens, because the notion of resource management is not referenced in the semantics.</p>
</blockquote>
</li>
<li><p><strong>Destructive move or non-destructive</strong>: move in cpp is non-destructive while in rust is the opposite; <strong>DESTRUCTIVE MOVE</strong> here means there is a GAP between move ctor and the ends of object’s lifetime, moved-from object in this period stays in a unspecified&#x2F;“empty-but-valid” state, which is dangerous and leave some space to operate. Thus, <strong>you can’t make any assumptions based on that unless is fully stated in the doc</strong>. For example, <code>std::string</code> does not make any promises about the contents of a moved-from string, so you can’t assume that moved-from string is empty; In rust, there is no gap between them, “<strong>The move replaces the dtor call at the end of the block, at compile time</strong>“, and you can’t refer(rd&#x2F;wr) the moved-from object after moving because the lifetime of it is terminated instantly when MOVE, or you’ll get a nice greeting from compiler; But that’s the problem! Especially when you use moved-from objects while the lifetime of it ain’t finish yet, like a file handle but not pointing to a file, or, a unique_ptr points to nothing; and it’s kind of… creepy&#x2F;buggy&#x2F;unsafe, i mean, just think about it… And one of the interesting things is, in most use-cases, <strong>we assumed that THEY’re not NULL</strong> despite the theoretical possibility; So you choose to add a check towards unique_ptr whether is nullptr when dereferencing everywhere, like <code>if err != nil</code></p>
<blockquote>
<p>But this is a surprise. This is a result of the “unspecified value.” And so while it may, strictly speaking, be “safe” to do things with a moved-from object other than destruct them or assign to them, in practice, without documentation to the contrary making stronger guarantees, the only way to get “not surprising” behavior is to greatly limit what you do with moved-from objects.</p>
</blockquote>
<blockquote>
<p>Again, this attitude, that a null pointer is a normal pointer, that an empty thread handle is a normal type of thread handle, is adaptive to programming C++. But it will inevitably exist in a programmer’s blind spot, as null pointers always have. The “not null” invariant is often expressed implicitly. Many uses of std::unique_ptr are relying on them never being null, and simply leave this up to the programmer to ensure.</p>
</blockquote>
<blockquote>
<p>But in a sense, this is exactly what std::unique_ptr is. It has a special state where you cannot call its most important operator, the dereference operator. It only avoids being called buggy because it expands this state so it can be arrived at by other means.</p>
</blockquote>
<blockquote>
<p>Again, everything Herb Sutter says is true in a strict sense. It is memory-safe to use moved-from objects other than to destroy or assign to them, even if the move operation makes no further guarantees. It simply isn’t safe in a broader sense, in that it will have surprising, changeable behavior. It is true that the null pointer is a valid value of std::unique_ptr, but smart pointers that implement move are forced to have such a value.</p>
</blockquote>
</li>
</ul>
<h2 id="End-Possibly-not…"><a href="#End-Possibly-not…" class="headerlink" title="End? Possibly not…"></a>End? Possibly not…</h2><p>There are still things left to explore, like how can a element of the vector use its ctor, is it concerned with <code>placement new</code>?</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/cpp/" rel="tag"># cpp</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/03/05/born/" rel="prev" title="第一篇博客">
                  <i class="fa fa-chevron-left"></i> 第一篇博客
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/05/02/wrapper-type-in-rust/" rel="next" title="Wrapper? De-wrap it!">
                  Wrapper? De-wrap it! <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Detcher</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">23k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">21 分钟</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
